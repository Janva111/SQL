-- SQL DDL(data definotion language) .. vytvoreni, zmena, smazani objektu
-- vytvoreni databaze
Create database obchod;
-- prepnuti do nasi databaze
use obchod;
-- vytvoreni tabulky na strane 1, primary key ..not nuul, unique,index
-- identity .. automaticky generovany pk od 1 s krokem 10
Create table zanr(
id int primary key identity(1,1),
nazev varchar(20) not null unique
);
-- vytvoreni tabulky na strane N, cizi klic ..not nuul, unique,index
Create table film(
id int primary key identity(1,1),
nazev varchar(20) not null check(len(Nazev)>=3),
delka int NOT NULL check(delka > 0),
zanr_id int not null foreign key references zanr(id)
);
-- diagram ..prave tl na database diagram/new diagram yes
-- uprava struktury tabulky film, pridani attributu dabing boolean
alter table film add dabing bit;
-- smazani tabulky na strane 1 nepujde, protoze na ni odkazuje tabulka na strane N
drop table zanr;
-- napred smazat tabulku na strane N
drop table film;
-- smazani cele databaze
-- prepneme se do systemu
use master;
-- a smazeme
drop database obchod;
select getdate()
- cast omezi na systemove datum
select cast(getdate()as date)

alter table hrac add vek int;
-- pridame omezeni not null
alter table hrac alter column vek int not null;

-- SQL DML(data mainpulation language) .. prikazy, ktere pracuji s daty
-- insert into, delete from, update, select
-- vlozeni dat do zanru
-- apostrof '
insert into zanr(nazev) values('sci-fi'), ('fantasy');
-- vypis vsech dat z tabulky zanr
select * from zanr order by id;
- vraci datum a cas

MOCKAROO - generovani zaznamu do tabulky

create database priklady;
use priklady;
-- selfreference 1:n, hierarchie
create table zam(
id int primary key identity(1,1),
pozice varchar(20),
prijmeni varchar(20),
nadrizeny_id int foreign key references zam(id)
);
select*from zam;
-- vypis nadrizene a jejich prime podrizene
select concat(nadrizeny.pozice,': ',nadrizeny.prijmeni) as vedouci,
concat(podrizeny.pozice,': ',podrizeny.prijmeni) as podrizeny
from zam as nadrizeny inner join zam as podrizeny on nadrizeny.id =podrizeny.nadrizeny_id;

-- selreference m:n, zapasy mezi tymy
create table tym(
id int primary key identity(1,1),
nazev varchar(20) not null unique
)
insert into tym(nazev) values('plzen'),('jablonec'),('banik'),('SPARTA'),('sesivky')

create table zapas(
id int primary key identity(1,1),
domaci_tym_id int foreign key references tym(id),
host_tym_id int foreign key references tym(id),
datum date,
vysledek varchar(20),
domaci_body int check(domaci_body in(3,1,0)),
check (domaci_tym_id != host_tym_id)
)

-- vypis tymu(domaci,host),datum,vysledek a domaci_body
select domaci.nazev, host.nazev, zapas.datum, zapas.vysledek, zapas.domaci_body
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id;

-- vypiste totez, ale pridejte body, ktere ziskali hoste
-- body hostu jsou komplement k bodum domacich
select domaci.nazev, host.nazev, zapas.datum, zapas.vysledek, zapas.domaci_body, case when zapas.domaci_body=3 then 0 when zapas.domaci_body=0 then 3
when zapas.domaci_body=1 then 1 end as hoste_body
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id;

-- vypise celkovy pocet bodu pro kazdy tym ziskany doma

select domaci.nazev, sum(zapas.domaci_body) as body_doma_celkem
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id
group by domaci.nazev;

-- vypiste celkovy pocet bodu pro kazdy tym ziskany venku

select host.nazev, sum(case when zapas.domaci_body=3 then 0 when zapas.domaci_body=0 then 3
when zapas.domaci_body=1 then 1 end) as body_venku_celkem
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id
group by host.nazev;

-- celkovy zisk bodu = venku+doma
select nazev, sum(body)as body_celkem
from(

-- vypise celkovy pocet bodu pro kazdy tym ziskany doma
select domaci.nazev, sum(zapas.domaci_body) as body
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id
group by domaci.nazev

union all 

-- vypiste celkovy pocet bodu pro kazdy tym ziskany venku
select host.nazev, sum(case when zapas.domaci_body=3 then 0 when zapas.domaci_body=0 then 3
when zapas.domaci_body=1 then 1 end) as body
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id
group by host.nazev

) as vysledek_celkem
group by nazev
order by body_celkem desc;


