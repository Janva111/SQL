-- SQL DDL(data definotion language) .. vytvoreni, zmena, smazani objektu
-- vytvoreni databaze
Create database obchod;
-- prepnuti do nasi databaze
use obchod;
-- vytvoreni tabulky na strane 1, primary key ..not nuul, unique,index
-- identity .. automaticky generovany pk od 1 s krokem 10
Create table zanr(
id int primary key identity(1,1),
nazev varchar(20) not null unique
);
-- vytvoreni tabulky na strane N, cizi klic ..not nuul, unique,index
Create table film(
id int primary key identity(1,1),
nazev varchar(20) not null check(len(Nazev)>=3),
delka int NOT NULL check(delka > 0),
zanr_id int not null foreign key references zanr(id)
);
-- diagram ..prave tl na database diagram/new diagram yes
-- uprava struktury tabulky film, pridani attributu dabing boolean
alter table film add dabing bit;
-- smazani tabulky na strane 1 nepujde, protoze na ni odkazuje tabulka na strane N
drop table zanr;
-- napred smazat tabulku na strane N
drop table film;
-- smazani cele databaze
-- prepneme se do systemu
use master;
-- a smazeme
drop database obchod;
select getdate()
- cast omezi na systemove datum
select cast(getdate()as date)

alter table hrac add vek int;
-- pridame omezeni not null
alter table hrac alter column vek int not null;

-- SQL DML(data mainpulation language) .. prikazy, ktere pracuji s daty
-- insert into, delete from, update, select
-- vlozeni dat do zanru
-- apostrof '
insert into zanr(nazev) values('sci-fi'), ('fantasy');
-- vypis vsech dat z tabulky zanr
select * from zanr order by id;
- vraci datum a cas

MOCKAROO - generovani zaznamu do tabulky

create database priklady;
use priklady;
-- selfreference 1:n, hierarchie
create table zam(
id int primary key identity(1,1),
pozice varchar(20),
prijmeni varchar(20),
nadrizeny_id int foreign key references zam(id)
);
select*from zam;
-- vypis nadrizene a jejich prime podrizene
select concat(nadrizeny.pozice,': ',nadrizeny.prijmeni) as vedouci,
concat(podrizeny.pozice,': ',podrizeny.prijmeni) as podrizeny
from zam as nadrizeny inner join zam as podrizeny on nadrizeny.id =podrizeny.nadrizeny_id;

-- selreference m:n, zapasy mezi tymy
create table tym(
id int primary key identity(1,1),
nazev varchar(20) not null unique
)
insert into tym(nazev) values('plzen'),('jablonec'),('banik'),('SPARTA'),('sesivky')

create table zapas(
id int primary key identity(1,1),
domaci_tym_id int foreign key references tym(id),
host_tym_id int foreign key references tym(id),
datum date,
vysledek varchar(20),
domaci_body int check(domaci_body in(3,1,0)),
check (domaci_tym_id != host_tym_id)
)

-- vypis tymu(domaci,host),datum,vysledek a domaci_body
select domaci.nazev, host.nazev, zapas.datum, zapas.vysledek, zapas.domaci_body
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id;

-- vypiste totez, ale pridejte body, ktere ziskali hoste
-- body hostu jsou komplement k bodum domacich
select domaci.nazev, host.nazev, zapas.datum, zapas.vysledek, zapas.domaci_body, case when zapas.domaci_body=3 then 0 when zapas.domaci_body=0 then 3
when zapas.domaci_body=1 then 1 end as hoste_body
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id;

-- vypise celkovy pocet bodu pro kazdy tym ziskany doma

select domaci.nazev, sum(zapas.domaci_body) as body_doma_celkem
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id
group by domaci.nazev;

-- vypiste celkovy pocet bodu pro kazdy tym ziskany venku

select host.nazev, sum(case when zapas.domaci_body=3 then 0 when zapas.domaci_body=0 then 3
when zapas.domaci_body=1 then 1 end) as body_venku_celkem
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id
group by host.nazev;

-- celkovy zisk bodu = venku+doma
select nazev, sum(body)as body_celkem
from(

-- vypise celkovy pocet bodu pro kazdy tym ziskany doma
select domaci.nazev, sum(zapas.domaci_body) as body
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id
group by domaci.nazev

union all 

-- vypiste celkovy pocet bodu pro kazdy tym ziskany venku
select host.nazev, sum(case when zapas.domaci_body=3 then 0 when zapas.domaci_body=0 then 3
when zapas.domaci_body=1 then 1 end) as body
from tym as domaci inner join zapas on domaci.id =zapas.domaci_tym_id
inner join tym as host on host.id = zapas.host_tym_id
group by host.nazev

) as vysledek_celkem
group by nazev
order by body_celkem desc;

-- Vozidla

create table Typ_paliva(
id int primary key identity(1,1),
nazev varchar(20)not null unique,
)

create table Typ_auta(
id int primary key identity(1,1),
nazev varchar(20)not null unique,
)

create table Vuz(
id int primary key identity(1,1),
typ_auta_id int not null foreign key references Typ_Auta(id),
typ_paliva_id int not null foreign key references Typ_paliva(id),
nosnost int not null check(nosnost between 200 and 2400),
datum_vyroby date not null check(year(datum_vyroby)>2000),
spotreba int not null,
stav char(1) not null check(stav in ('A','B','C'))
)

create table Jizda(
id int primary key identity(1,1),
vuz_id int not null foreign key references Vuz(id),
datum date not null,
hodina int not null check(hodina between 0 and 24),
tachometr_start int not null,
tachometr_end int not null,
doba_jizdy int not null check(doba_jizdy>0),
check(tachometr_end>tachometr_start)
)

create table doplneni_paliva(
id int primary key identity(1,1),
jizda_id int not null foreign key references Jizda(id),
datum date not null,
hodina int not null check(hodina between 0 and 24),
mnozstvi int not null check(mnozstvi>0)
)

-- Typ_paliva
insert into Typ_paliva (nazev) values
('Benzin'),
('Nafta'),
('Elektro');

-- Typ_auta
insert into Typ_auta (nazev) values
('Osobni'),
('Dodavka'),
('Nakladni');

-- Vuz
insert into Vuz (typ_auta_id, typ_paliva_id, nosnost, datum_vyroby, spotreba, stav) values
(1, 1, 500,  '2015-06-10', 7,  'A'),
(2, 2, 1200, '2018-03-22', 9,  'B'),
(3, 3, 2000, '2021-11-05', 0,  'A');

-- Jizda
insert into Jizda (vuz_id, datum, hodina, tachometr_start, tachometr_end, doba_jizdy) values
(1, '2023-05-10', 8,  15000, 15080, 90),
(2, '2023-05-11', 14, 82000, 82120, 120),
(3, '2023-05-12', 6,  30000, 30150, 180);

-- doplneni_paliva
insert into doplneni_paliva (jizda_id, datum, hodina, mnozstvi) values
(1, '2023-05-10', 10, 40),
(2, '2023-05-11', 16, 60),
(3, '2023-05-12', 9,  30);


-- vypis vsechny jizdy vcetne vozu, typu, paliva a jeho doplneni

select * from Vuz inner join Typ_auta  on Typ_auta.id = Vuz.typ_auta_id where Typ_auta.nazev = 'nakladni' and year(datum_vyroby)>2015 and nosnost>10000

select Jizda.id, Typ_auta.nazev, (Jizda.tachometr_end-Jizda.tachometr_start) as ujeto from Jizda inner join Vuz on Vuz.id = Jizda.vuz_id inner join Typ_auta on Typ_auta.id = Vuz.typ_auta_id

-- Procedury

create database adresar
use adresar

create table email(
id int primary key identity(1,1),
adresa varchar(50) not null check(adresa like'%@%'),
datum datetime not null
)

go
create procedure pridat_adresu @adresa varchar(50)
as
begin
	set @adresa = lower(@adresa);
	if not exists(select*from email where adresa = @adresa)
	begin
	insert into email(adresa,datum) values (@adresa,GETDATE());
	end
end
go

-- spusteni procedury
execute pridat_adresu 'kos@gmail.com';
select*from email;

